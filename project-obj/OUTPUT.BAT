@echo off
setlocal EnableExtensions EnableDelayedExpansion

SET /A COUNT=0


rem rem push whole file at once
rem COPY LIST.TXT IN.TXT>NUL
rem ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
rem ECHO LOCK>LOCK_REQ_BY_INPUT.TXT
rem IF EXIST LOCK_REQ_BY_INPUT.TXT (
rem 	ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
rem :WAIT1
rem 	IF EXIST LOCK_REQ_BY_INPUT.TXT GOTO :WAIT1
rem )
rem ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
rem :WAIT2
rem CALL :TEST quit
rem TIMEOUT 1 >NUL
rem IF EXIST LOCK_REQ_BY_INPUT.TXT GOTO :WAIT2
rem EXIT /B





for /f "tokens=*" %%G in (LIST.TXT) do (
	call :TEST %%G
)
CALL :TEST quit
PAUSE
EXIT /B

:TEST

IF EXIST LOCK_REQ_BY_INPUT.TXT (
	ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
:WAIT1
	IF EXIST LOCK_REQ_BY_INPUT.TXT GOTO :WAIT1
)

SET /A COUNT=!COUNT! + 1

if %1 == quit (
	ECHO quit>>IN.TXT
	ECHO quit>QUIT.TXT
	ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
	EXIT /B
)

ECHO %1.!COUNT!>>IN.TXT
ECHO %1 !COUNT!

EXIT /B
