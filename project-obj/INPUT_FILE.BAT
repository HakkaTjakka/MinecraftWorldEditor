@echo off
setlocal EnableExtensions EnableDelayedExpansion

IF EXIST IN.TXT DEL IN.TXT
IF EXIST IN.TXT DEL IN2.TXT
IF EXIST OUT.TXT DEL OUT.TXT
IF EXIST LOCK_REQ_BY_INPUT.TXT DEL LOCK_REQ_BY_INPUT.TXT

SET /A COUNT=0
SET /A BATCH=0

ECHO STARTED>STARTED.TXT

:AGAIN

ECHO LOCK>LOCK_REQ_BY_INPUT.TXT
:WAIT1
IF NOT EXIST LOCK_ACK_BY_OUTPUT.TXT (
	IF EXIST QUIT.TXT GOTO :END
	GOTO :WAIT1
)
IF EXIST LOCK_ACK_BY_OUTPUT.TXT DEL LOCK_ACK_BY_OUTPUT.TXT>NUL

IF EXIST IN.TXT (
	SET /A BATCH=!BATCH! + 1
	COPY IN.TXT IN!BATCH!.TXT>NUL
	DEL IN.TXT>NUL
	DEL LOCK_REQ_BY_INPUT.TXT>NUL
	ECHO FILE.IN!BATCH!.!BATCH!
)
IF EXIST LOCK_REQ_BY_INPUT.TXT DEL LOCK_REQ_BY_INPUT.TXT>NUL
IF NOT EXIST QUIT.TXT (
	TIMEOUT 3 >NUL
	GOTO :AGAIN
)

:END
EXIT /B
