@echo off
setlocal EnableExtensions EnableDelayedExpansion

IF EXIST IN.TXT DEL IN.TXT
IF EXIST IN.TXT DEL IN2.TXT
IF EXIST OUT.TXT DEL OUT.TXT
IF EXIST LOCK_REQ_BY_INPUT.TXT DEL LOCK_REQ_BY_INPUT.TXT

SET /A COUNT=0
SET /A BATCH=0
SET /A BATCH_COUNT=0

ECHO STARTED>STARTED.TXT

:AGAIN

IF EXIST LOCK_ACK_BY_OUTPUT.TXT DEL LOCK_ACK_BY_OUTPUT.TXT>NUL
ECHO LOCK>LOCK_REQ_BY_INPUT.TXT
:WAIT1
IF NOT EXIST QUIT.TXT (
	IF NOT EXIST LOCK_ACK_BY_OUTPUT.TXT (
		GOTO :WAIT1
	)
)

IF EXIST IN.TXT (
	SET /A BATCH=!BATCH! + 1
	COPY IN.TXT IN2.TXT>NUL
	DEL IN.TXT>NUL
	DEL LOCK_REQ_BY_INPUT.TXT>NUL
	
	SET /A BATCH_COUNT=0
	for /f "tokens=*" %%G in (IN2.TXT) do (
		if %%G == quit EXIT /B
		SET /A BATCH_COUNT=!BATCH_COUNT! + 1
		SET /A COUNT=!COUNT! + 1

		ECHO %%G.!COUNT!.dum
	)
)

IF EXIST LOCK_REQ_BY_INPUT.TXT DEL LOCK_REQ_BY_INPUT.TXT>NUL

IF NOT EXIST QUIT.TXT (
	TIMEOUT 3 >NUL
	GOTO :AGAIN
)

:END
EXIT /B
